# üîÑ –ü—Ä–æ–±–ª–µ–º–∞ —Å Event Loop –≤ API —Å–µ—Ä–≤–µ—Ä–µ

## üìã –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã

API —Å–µ—Ä–≤–µ—Ä –ø–∞–¥–∞–µ—Ç —Å –æ—à–∏–±–∫–æ–π:
```
‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ API v2 —Å–µ—Ä–≤–µ—Ä–∞: asyncio.run() cannot be called from a running event loop
```

## üîç –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã

### –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:
1. **API —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è** - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Ö–æ–¥–∏—Ç —É—Å–ø–µ—à–Ω–æ
2. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è** - SQLite —Å—Ö–µ–º–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è
3. **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è** - –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —á–∏—Ç–∞—é—Ç—Å—è
4. **–ü—Ä–∏ –∑–∞–ø—É—Å–∫–µ uvicorn** - –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –∫–æ–Ω—Ñ–ª–∏–∫—Ç event loops

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Å—É—Ç—å:
- –ì–¥–µ-—Ç–æ –≤ –∫–æ–¥–µ —É–∂–µ –∑–∞–ø—É—â–µ–Ω event loop
- `asyncio.run()` –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤—ã–∑–≤–∞–Ω –∏–∑ —É–∂–µ –∑–∞–ø—É—â–µ–Ω–Ω–æ–≥–æ event loop
- uvicorn —Å–∞–º —É–ø—Ä–∞–≤–ª—è–µ—Ç event loop'–æ–º

## üõ†Ô∏è –ß—Ç–æ —É–∂–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

### 1. –ó–∞–º–µ–Ω–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ –≤—ã–∑–æ–≤—ã:
```python
# –ë—ã–ª–æ:
loop = asyncio.get_event_loop()

# –°—Ç–∞–ª–æ:
loop = asyncio.get_running_loop()
```

**–§–∞–π–ª—ã:**
- `src/database/connection.py` (5 –º–µ—Å—Ç)
- `src/main.py` (2 –º–µ—Å—Ç–∞)

### 2. –î–æ–±–∞–≤–ª–µ–Ω nest_asyncio:
```python
# –í scripts/run_api_v2.py
try:
    import nest_asyncio
    nest_asyncio.apply()
except ImportError:
    pass
```

### 3. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ SQL —Å—Ö–µ–º–∞ PostgreSQL:
- –ü—Ä–æ–±–ª–µ–º–∞ —Å `run_statistics` view (–Ω–µ–ø–æ–ª–Ω—ã–µ –∏–º–µ–Ω–∞ —Ç–∞–±–ª–∏—Ü –≤ –ø–æ–¥–∑–∞–ø—Ä–æ—Å–∞—Ö)

## üîç –ì–¥–µ –∏—Å–∫–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—É

### 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–º–ø–æ—Ä—Ç—ã –≤ startup:
```python
# –í scripts/run_api_v2.py
from src.api.v2.server import api_server_v2  # ‚Üê –í–æ–∑–º–æ–∂–Ω–æ –∑–¥–µ—Å—å
from src.core.config import config
from src.database.connection import db_manager
```

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –º–æ–¥—É–ª–µ–π:
- `src/api/v2/server.py` - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è FastAPI
- `src/database/connection.py` - –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
- `src/core/config.py` - –∑–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

### 3. –í–æ–∑–º–æ–∂–Ω—ã–µ –º–µ—Å—Ç–∞ –ø—Ä–æ–±–ª–µ–º—ã:
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ event loop –≤ –∏–º–ø–æ—Ä—Ç–∞—Ö
- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —Å asyncio
- Middleware –∏–ª–∏ startup events –≤ FastAPI

## üß™ –°–ø–æ—Å–æ–±—ã –æ—Ç–ª–∞–¥–∫–∏

### 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –≥–¥–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è event loop:
```python
import asyncio
import inspect

def check_event_loop():
    try:
        loop = asyncio.get_running_loop()
        print(f"Event loop —É–∂–µ –∑–∞–ø—É—â–µ–Ω: {loop}")
        print(f"–°—Ç–µ–∫ –≤—ã–∑–æ–≤–æ–≤: {inspect.stack()}")
    except RuntimeError:
        print("Event loop –Ω–µ –∑–∞–ø—É—â–µ–Ω")
```

### 2. –î–æ–±–∞–≤–∏—Ç—å –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é:
```python
# –í scripts/run_api_v2.py –ø–µ—Ä–µ–¥ uvicorn.run()
print(f"Event loop status: {asyncio.get_event_loop().is_running()}")
```

### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ asyncio.run() –≤ –∫–æ–¥–µ:
```bash
grep -r "asyncio.run" src/ scripts/ --include="*.py"
```

## üí° –í–æ–∑–º–æ–∂–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è

### 1. –ü–æ–ª–Ω–æ—Å—Ç—å—é —É–±—Ä–∞—Ç—å asyncio.run():
```python
# –í–º–µ—Å—Ç–æ asyncio.run(main())
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä—è–º–æ–π –∑–∞–ø—É—Å–∫ uvicorn
uvicorn.run(app, host=host, port=port)
```

### 2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å startup/shutdown events:
```python
# –í FastAPI app
@app.on_event("startup")
async def startup():
    await db_manager.connect()

@app.on_event("shutdown") 
async def shutdown():
    await db_manager.disconnect()
```

### 3. –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å –Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–Ω—É—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é:
```python
# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ë–î —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ
# –ó–∞–ø—É—Å—Ç–∏—Ç—å uvicorn –±–µ–∑ asyncio
```

## üìä –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å

- ‚úÖ **PostgreSQL**: —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è
- ‚úÖ **Redis**: —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ  
- ‚úÖ **Docker**: –æ–±—Ä–∞–∑—ã —Å–æ–±–∏—Ä–∞—é—Ç—Å—è
- ‚úÖ **SQLite**: —Å—Ö–µ–º–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è
- ‚ùå **API —Å–µ—Ä–≤–µ—Ä**: –ø–∞–¥–∞–µ—Ç –Ω–∞ startup

## üéØ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–ù–∞–π—Ç–∏ root cause** - –≥–¥–µ –∏–º–µ–Ω–Ω–æ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è event loop
2. **–ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å startup –ª–æ–≥–∏–∫—É** - —É–±—Ä–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏–µ asyncio.run()
3. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å** - —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ API –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –∑–∞–ø—Ä–æ—Å—ã
4. **–ó–∞–ø—É—Å—Ç–∏—Ç—å –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã** - dashboard, bot, strategy runner

## üìù –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

```bash
# –ó–∞–ø—É—Å–∫ —Ç–æ–ª—å–∫–æ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã
docker-compose -f docker-compose.v2.yml up postgres redis -d

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ API
docker-compose -f docker-compose.v2.yml logs api

# –¢–µ—Å—Ç API (–∫–æ–≥–¥–∞ –∑–∞—Ä–∞–±–æ—Ç–∞–µ—Ç)
curl http://localhost:8000/healthz
curl http://localhost:8000/docs
```

---
*–ü—Ä–æ–±–ª–µ–º–∞ —Ç—Ä–µ–±—É–µ—Ç –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ startup –ø—Ä–æ—Ü–µ—Å—Å–∞ –∏ –≤–æ–∑–º–æ–∂–Ω–æ–π —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏.*
