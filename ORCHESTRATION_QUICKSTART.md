# üöÄ Gregory Trading Agent - n8n Orchestration Quickstart

## ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –∑–∞–ø—É—Å–∫—É!

–°–∏—Å—Ç–µ–º–∞ n8n –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏–∏ –¥–ª—è Gregory Trading Agent –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é.

## üèóÔ∏è –ß—Ç–æ –±—ã–ª–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### 1. **–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞**
- ‚úÖ **PostgreSQL** - –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏–∏ (—Å—Ö–µ–º–∞, —Ç–∞–±–ª–∏—Ü—ã)  
- ‚úÖ **n8n** - –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä —Å Queue Mode –∏ Redis
- ‚úÖ **FastAPI** - API —Å–µ—Ä–≤–µ—Ä —Å 9 orchestration endpoints
- ‚úÖ **Docker Compose** - –ø–æ–ª–Ω–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞—Ö

### 2. **API Endpoints** 
| Endpoint | –§—É–Ω–∫—Ü–∏—è | –°—Ç–∞—Ç—É—Å |
|----------|---------|--------|
| `POST /ingest` | –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö | ‚úÖ |
| `POST /train` | –û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏ | ‚úÖ |
| `POST /backtest` | –ë—ç–∫—Ç–µ—Å—Ç–∏–Ω–≥ | ‚úÖ |
| `POST /promote` | –ê–∫—Ç–∏–≤–∞—Ü–∏—è –º–æ–¥–µ–ª–∏ | ‚úÖ |
| `POST /prepare` | –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è | ‚úÖ |
| `POST /execute` | –ó–∞–ø—É—Å–∫ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ | ‚úÖ |
| `GET /status/{run_id}` | –°—Ç–∞—Ç—É—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è | ‚úÖ |
| `GET /metrics` | –ñ–∏–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ | ‚úÖ |
| `POST /notify` | Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è | ‚úÖ |
| `GET /health` | –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è | ‚úÖ |

### 3. **n8n –í–æ—Ä–∫—Ñ–ª–æ—É**
- ‚úÖ **Nightly Retrain** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–æ–±—É—á–µ–Ω–∏–µ (2:00 AM)
- ‚úÖ **Metrics Guard** - –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –º–µ—Ç—Ä–∏–∫ (–∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç)  
- ‚úÖ **Run Strategy** - –∑–∞–ø—É—Å–∫ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π –ø–æ webhook
- üîÑ **Upload & Deploy** - –∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π (TODO)

### 4. **–°–∏—Å—Ç–µ–º–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤**
- ‚úÖ –£–Ω–∏–∫–∞–ª—å–Ω—ã–µ `run_id` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
- ‚úÖ –•—Ä–∞–Ω–µ–Ω–∏–µ –≤ `/artifacts/<run_id>/`
- ‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏ –≤ JSONL
- ‚úÖ –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –∏ –º–µ—Ç—Ä–∏–∫–∏ –≤ JSON

### 5. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –∞–ª–µ—Ä—Ç—ã**
- ‚úÖ Quality thresholds (Sharpe, MaxDD, staleness)
- ‚úÖ Telegram —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π
- ‚úÖ Emergency stop –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –Ω–∞—Ä—É—à–µ–Ω–∏—è—Ö
- ‚úÖ Retry policy —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–º backoff

## üöÄ –ë—ã—Å—Ç—Ä—ã–π –∑–∞–ø—É—Å–∫

### 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è
```bash
cd gregory_active_agent

# –°–æ–∑–¥–∞—Ç—å .env —Ñ–∞–π–ª –∏–∑ –ø—Ä–∏–º–µ—Ä–∞
cp env.example .env

# –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å .env —Å –≤–∞—à–∏–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏:
# - POSTGRES_PASSWORD
# - N8N_PASSWORD  
# - TELEGRAM_BOT_TOKEN
# - API –∫–ª—é—á–∏
```

### 2. –ó–∞–ø—É—Å–∫ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã
```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã
make docker-up

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
docker-compose ps

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏
make docker-logs
```

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ n8n
```bash
# –û—Ç–∫—Ä—ã—Ç—å n8n UI
make n8n-ui
# –∏–ª–∏ http://localhost:5678

# –í–æ–π—Ç–∏ —Å credentials –∏–∑ .env:
# Login: admin (N8N_USER)
# Password: –≤–∞—à_–ø–∞—Ä–æ–ª—å (N8N_PASSWORD)

# –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤–æ—Ä–∫—Ñ–ª–æ—É:
# Settings > Import/Export > Import
# –§–∞–π–ª—ã: ops/n8n/*.json
```

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å API
make api-test

# –û—Ç–∫—Ä—ã—Ç—å –¥–∞—à–±–æ—Ä–¥  
make dashboard-ui

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –ë–î
make db-status

# –¢–µ—Å—Ç –∑–∞–ø—É—Å–∫–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
make trigger-retrain
```

## üéØ –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

| –ö–æ–º–∞–Ω–¥–∞ | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|----------|
| `make docker-up` | –ó–∞–ø—É—Å—Ç–∏—Ç—å –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É |
| `make docker-down` | –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ |
| `make api-test` | –ü—Ä–æ–≤–µ—Ä–∏—Ç—å API |
| `make n8n-ui` | –û—Ç–∫—Ä—ã—Ç—å n8n |
| `make dashboard-ui` | –û—Ç–∫—Ä—ã—Ç—å –¥–∞—à–±–æ—Ä–¥ |
| `make db-status` | –°—Ç–∞—Ç—É—Å –∑–∞–ø—É—Å–∫–æ–≤ |
| `make docker-logs` | –õ–æ–≥–∏ —Å–µ—Ä–≤–∏—Å–æ–≤ |

## üì° API –ø—Ä–∏–º–µ—Ä—ã

### –ó–∞–ø—É—Å–∫ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ —á–µ—Ä–µ–∑ webhook:
```bash
curl -X POST http://localhost:5678/webhook/run-strategy \
  -H "Content-Type: application/json" \
  -d '{
    "strategy_id": "eurusd_mtf",
    "mode": "paper",
    "params": {"risk_factor": 0.02}
  }'
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞:
```bash
curl http://localhost:8000/status/your_run_id
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫:
```bash
curl http://localhost:8000/metrics
```

## üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

–û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã PostgreSQL:
- **`strategies`** - –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
- **`models`** - –æ–±—É—á–µ–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏  
- **`runs`** - –∏—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö –∑–∞–ø—É—Å–∫–æ–≤
- **`failed_jobs`** - –Ω–µ—É–¥–∞—á–Ω—ã–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- **`live_metrics`** - —Ç–µ–∫—É—â–∏–µ –º–µ—Ç—Ä–∏–∫–∏

```sql
-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
make db-connect

-- –ü—Ä–æ—Å–º–æ—Ç—Ä –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∑–∞–ø—É—Å–∫–æ–≤
SELECT * FROM runs ORDER BY started_at DESC LIMIT 5;

-- –ü—Ä–æ—Å–º–æ—Ç—Ä –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π
SELECT * FROM strategies WHERE active_model_id IS NOT NULL;
```

## üîÑ –í–æ—Ä–∫—Ñ–ª–æ—É —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. Nightly Retrain (—Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫)
–ó–∞–ø—É—Å—Ç–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ 2:00 AM –∏–ª–∏ –º–æ–∂–Ω–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ n8n UI

### 2. Metrics Guard  
–†–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

### 3. Run Strategy
```bash
# –ß–µ—Ä–µ–∑ webhook
curl -X POST http://localhost:5678/webhook/run-strategy \
  -d '{"strategy_id": "eurusd_mtf", "mode": "paper"}'
```

## üîç Troubleshooting

### –ü—Ä–æ–±–ª–µ–º—ã —Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º
```bash
# –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤
docker-compose ps

# –õ–æ–≥–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞  
docker-compose logs gregory-api
docker-compose logs gregory-n8n
docker-compose logs gregory-postgres
```

### –ü—Ä–æ–±–ª–µ–º—ã —Å n8n
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Å–µ—Ä–≤–∏—Å—ã –∑–∞–ø—É—â–µ–Ω—ã: `docker-compose ps`
2. –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ Gregory API –¥–æ—Å—Ç—É–ø–µ–Ω: `make api-test`
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ n8n: `docker-compose logs gregory-n8n`

### –ü—Ä–æ–±–ª–µ–º—ã —Å –ë–î
```bash
# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
make db-connect

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∞–±–ª–∏—Ü
\dt

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö
SELECT COUNT(*) FROM runs;
```

## üéâ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª**: –∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ ‚Üí retrain ‚Üí deploy
2. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ API –∫–ª—é—á–∏** –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
3. **–î–æ–±–∞–≤–∏—Ç—å Upload & Deploy –≤–æ—Ä–∫—Ñ–ª–æ—É** –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π
4. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ (Prometheus, Grafana)
5. **–î–æ–±–∞–≤–∏—Ç—å S3 storage** –¥–ª—è –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- **–ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**: `ops/README.md`
- **API —Å—Ö–µ–º–∞**: http://localhost:8000/docs (–ø–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞)
- **n8n –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è**: https://docs.n8n.io
- **PostgreSQL —Å—Ö–µ–º–∞**: `ops/sql/init.sql`

---

**üéØ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ–º—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!**

Gregory Trading Agent —Ç–µ–ø–µ—Ä—å –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω —Å n8n –æ—Ä–∫–µ—Å—Ç—Ä–∞—Ü–∏–µ–π –∏ –≥–æ—Ç–æ–≤ –∫ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–º—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º —Å—Ç—Ä–∞—Ç–µ–≥–∏–π.
